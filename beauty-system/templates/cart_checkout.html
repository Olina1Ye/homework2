<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <title>结算 - 美妆商城</title>
    <style>
        .nav-link {
            @apply px-4 py-2 text-gray-700 hover:text-pink-500 transition;
        }
        .divider {
            height: 1px;
            background-color: #e5e7eb;
            margin: 1rem 0;
        }
        .cart-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <a href="{{ url_for('index') }}" class="text-xl font-bold text-pink-500">美妆商城</a>
            <div class="flex items-center space-x-4">
                <a href="{{ url_for('index') }}" class="nav-link">首页</a>
                <a href="{{ url_for('index', category='all') }}" class="nav-link">分类</a>
                <a href="{{ url_for('cart') }}" class="nav-link">
                    <i class="fa fa-shopping-cart mr-1"></i> 购物车
                </a>
                {% if 'user_id' in session %}
                    <a href="#" class="nav-link">欢迎，{{ session['username'] }}</a>
                    <a href="{{ url_for('logout') }}" class="nav-link text-red-500">退出</a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="nav-link">登录</a>
                    <a href="{{ url_for('register') }}" class="nav-link text-green-500">注册</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- 主体内容 -->
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-2xl font-bold mb-6">订单结算</h1>
        
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- 订单信息 -->
            <div class="lg:w-2/3">
                <!-- 收货地址 -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">收货地址</h2>
                    <form id="addressForm" class="space-y-4">
                        <div>
                            <label class="block mb-1 font-medium">收件人</label>
                            <input type="text" name="recipient" required 
                                   class="w-full px-3 py-2 border rounded">
                        </div>
                        
                        <div>
                            <label class="block mb-1 font-medium">联系电话</label>
                            <input type="tel" name="phone" required 
                                   class="w-full px-3 py-2 border rounded">
                        </div>
                        
                        <div>
                            <label class="block mb-1 font-medium">详细地址</label>
                            <textarea name="address" required rows="3" 
                                      class="w-full px-3 py-2 border rounded"></textarea>
                        </div>
                    </form>
                </div>
                
                <!-- 订单商品 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4">订单商品</h2>
                    <div class="space-y-4">
                        {% for item in cart_items %}
                        <div class="flex items-center gap-4 pb-4 border-b border-gray-100">
                            <!-- 左侧图片 -->
                            <img src="{{ url_for('static', filename=item.product.image) }}" alt="{{ item.product.name }}" class="cart-item-image rounded">
                            
                            <!-- 右侧文字信息 -->
                            <div class="flex-1 text-left">
                                <h3 class="font-medium">{{ item.product.name }}</h3>
                                <p class="text-gray-500">数量: {{ item.quantity }}</p>
                                <p class="text-pink-600">单价: ¥{{ item.product.price }}</p>
                            </div>
                            
                            <!-- 右侧总价 -->
                            <div class="text-gray-700 font-medium">
                                ¥{{ item.product.price * item.quantity }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- 支付信息 -->
            <div class="lg:w-1/3">
                <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
                    <h2 class="text-xl font-bold mb-4">支付信息</h2>
                    
                    <div class="space-y-2 mb-6">
                        {% for item in cart_items %}
                        <div class="flex justify-between text-sm">
                            <span>{{ item.product.name }} x {{ item.quantity }}</span>
                            <span>¥{{ item.product.price * item.quantity }}</span>
                        </div>
                        {% endfor %}
                        
                        <div class="divider"></div>
                        
                        <div class="flex justify-between font-bold text-lg">
                            <span>总计</span>
                            <span class="text-pink-600">¥{{ total_price }}</span>
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold mb-4">支付方式</h2>
                    <div class="space-y-3 mb-6">
                        <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="payment" value="alipay" checked class="mr-2">
                            <i class="fa fa-credit-card mr-2 text-blue-500"></i> 支付宝
                        </label>
                        <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="payment" value="wechat" class="mr-2">
                            <i class="fa fa-wechat mr-2 text-green-500"></i> 微信支付
                        </label>
                    </div>
                    
                    <button id="payButton" class="w-full bg-pink-500 hover:bg-pink-600 text-white py-3 rounded text-lg font-bold transition">
                        确认支付
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 支付按钮点击事件
        document.getElementById('payButton').addEventListener('click', function() {
            // 验证地址信息
            const recipient = document.querySelector('input[name="recipient"]').value;
            const phone = document.querySelector('input[name="phone"]').value;
            const address = document.querySelector('textarea[name="address"]').value;
            
            if (!recipient || !phone || !address) {
                alert('请填写完整的收货信息');
                return;
            }
            
            // 显示加载状态
            this.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 处理中...';
            this.disabled = true;
            
            // 模拟支付过程
            setTimeout(() => {
                fetch('/process_cart_payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    body: JSON.stringify({
                        recipient: recipient,
                        phone: phone,
                        address: address,
                        payment_method: document.querySelector('input[name="payment"]:checked').value
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        window.location.href = data.redirect_url;
                    } else {
                        alert(data.message);
                        this.innerHTML = '确认支付';
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('支付失败:', error);
                    alert('支付失败，请重试');
                    this.innerHTML = '确认支付';
                    this.disabled = false;
                });
            }, 1500);
        });
    </script>
</body>
</html>